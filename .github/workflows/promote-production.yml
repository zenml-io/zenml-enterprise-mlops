name: Promote to Production

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      model_version:
        description: 'Model version to promote (e.g., 1 or "latest")'
        required: false
        default: 'latest'
      force:
        description: 'Force promotion (demote current production model)'
        required: false
        type: boolean
        default: false

jobs:
  build-snapshot:
    runs-on: ubuntu-latest
    environment:
      name: production
    env:
      ZENML_STORE_URL: ${{ secrets.ZENML_STORE_URL }}
      ZENML_STORE_API_KEY: ${{ secrets.ZENML_STORE_API_KEY }}
      ZENML_PROJECT: ${{ secrets.ZENML_PROJECT || 'default' }}
      ZENML_PRODUCTION_STACK: ${{ secrets.ZENML_PRODUCTION_STACK || 'default' }}
      ZENML_GITHUB_SHA: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      - name: Connect to ZenML
        run: |
          zenml connect --url $ZENML_STORE_URL --api-key $ZENML_STORE_API_KEY
          zenml project set $ZENML_PROJECT

      - name: Set stack
        run: zenml stack set $ZENML_PRODUCTION_STACK

      # Create production snapshot (don't run yet - requires approval)
      - name: Build production snapshot (Pro)
        id: pro_build
        continue-on-error: true
        run: |
          python build.py \
            --environment production \
            --stack $ZENML_PRODUCTION_STACK

  promote-model:
    needs: build-snapshot
    runs-on: ubuntu-latest
    env:
      ZENML_STORE_URL: ${{ secrets.ZENML_STORE_URL }}
      ZENML_STORE_API_KEY: ${{ secrets.ZENML_STORE_API_KEY }}
      ZENML_PROJECT: ${{ secrets.ZENML_PROJECT || 'default' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      - name: Connect to ZenML
        run: |
          zenml connect --url $ZENML_STORE_URL --api-key $ZENML_STORE_API_KEY
          zenml project set $ZENML_PROJECT

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="${{ github.event.inputs.model_version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Promote to staging
        run: |
          if [ "${{ steps.version.outputs.version }}" == "latest" ]; then
            python scripts/promote_model.py \
              --model patient_readmission_predictor \
              --to-stage staging
          else
            python scripts/promote_model.py \
              --model patient_readmission_predictor \
              --version ${{ steps.version.outputs.version }} \
              --to-stage staging
          fi

      - name: Promote to production
        run: |
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            FORCE_FLAG="--force"
          fi

          python scripts/promote_model.py \
            --model patient_readmission_predictor \
            --from-stage staging \
            --to-stage production \
            $FORCE_FLAG

      - name: Create summary
        if: success()
        run: |
          echo "## ðŸš€ Production Promotion Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** patient_readmission_predictor" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** production" >> $GITHUB_STEP_SUMMARY
