name: Promote to Production

# This workflow handles cross-workspace model promotion from enterprise-dev-staging
# to enterprise-production. Part of the 2-workspace architecture for ZenML version
# upgrade isolation.
#
# Flow:
# 1. Export model from dev-staging workspace to shared GCS bucket
# 2. Wait for approval (GitHub environment protection)
# 3. Import model into production workspace with full metadata

on:
  release:
    types: [published]

  workflow_dispatch:
    inputs:
      model_version:
        description: 'Model version to promote (e.g., 1 or "staging" for latest staging)'
        required: false
        default: 'staging'
      force:
        description: 'Force promotion (demote current production model)'
        required: false
        type: boolean
        default: false

jobs:
  # Job 1: Export model from dev-staging workspace
  export-model:
    runs-on: ubuntu-latest
    outputs:
      export_path: ${{ steps.export.outputs.path }}
      model_version: ${{ steps.version.outputs.version }}
    env:
      # 2-Workspace Architecture: Connect to dev-staging for export
      ZENML_STORE_URL: ${{ secrets.ZENML_DEV_STAGING_STORE_URL }}
      ZENML_STORE_API_KEY: ${{ secrets.ZENML_DEV_STAGING_API_KEY }}
      ZENML_PROJECT: cancer-detection

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      # Set project (ZenML auto-connects via env vars)
      - name: Configure ZenML
        run: zenml project set $ZENML_PROJECT

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            # For releases, use tag name or default to staging
            VERSION="${{ github.event.release.tag_name }}"
            if [[ ! "$VERSION" =~ ^[0-9]+$ ]]; then
              VERSION="staging"
            fi
          else
            VERSION="${{ github.event.inputs.model_version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Export model to shared bucket
        id: export
        run: |
          python scripts/promote_cross_workspace.py \
            --model breast_cancer_classifier \
            --source-workspace enterprise-dev-staging \
            --source-stage ${{ steps.version.outputs.version }} \
            --export-only

          # The script writes the export path to export_path.txt
          EXPORT_PATH=$(cat export_path.txt)
          echo "path=$EXPORT_PATH" >> $GITHUB_OUTPUT

      - name: Create export summary
        run: |
          echo "## ðŸ“¦ Model Export Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** breast_cancer_classifier" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** enterprise-dev-staging workspace" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Export Path:** ${{ steps.export.outputs.path }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Waiting for production deployment approval..." >> $GITHUB_STEP_SUMMARY

  # Job 2: Import model into production workspace (requires approval)
  import-model:
    needs: export-model
    runs-on: ubuntu-latest
    environment:
      name: production  # GitHub environment with approval gate
    env:
      # 2-Workspace Architecture: Connect to production for import
      ZENML_STORE_URL: ${{ secrets.ZENML_PRODUCTION_STORE_URL }}
      ZENML_STORE_API_KEY: ${{ secrets.ZENML_PRODUCTION_API_KEY }}
      ZENML_PROJECT: cancer-detection
      ZENML_STACK: gcp-stack

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      # Set project and stack (ZenML auto-connects via env vars)
      - name: Configure ZenML
        run: |
          zenml project set $ZENML_PROJECT
          zenml stack set $ZENML_STACK

      - name: Import model to production
        run: |
          FORCE_FLAG=""
          if [ "${{ github.event.inputs.force }}" == "true" ]; then
            FORCE_FLAG="--force"
          fi

          python scripts/promote_cross_workspace.py \
            --model breast_cancer_classifier \
            --dest-workspace enterprise-production \
            --import-from "${{ needs.export-model.outputs.export_path }}" \
            --dest-stage production \
            $FORCE_FLAG

      - name: Create promotion summary
        if: success()
        run: |
          echo "## ðŸš€ Production Promotion Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** breast_cancer_classifier" >> $GITHUB_STEP_SUMMARY
          echo "**Source Version:** ${{ needs.export-model.outputs.model_version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Destination:** enterprise-production workspace" >> $GITHUB_STEP_SUMMARY
          echo "**Stage:** production" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cross-Workspace Lineage" >> $GITHUB_STEP_SUMMARY
          echo "Full training lineage preserved in **enterprise-dev-staging**." >> $GITHUB_STEP_SUMMARY
          echo "Metadata and audit links available in **enterprise-production**." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the model in the [ZenML Dashboard](https://cloud.zenml.io)" >> $GITHUB_STEP_SUMMARY

  # Job 3: Build batch inference snapshot in production
  build-inference-snapshot:
    needs: import-model
    runs-on: ubuntu-latest
    env:
      ZENML_STORE_URL: ${{ secrets.ZENML_PRODUCTION_STORE_URL }}
      ZENML_STORE_API_KEY: ${{ secrets.ZENML_PRODUCTION_API_KEY }}
      ZENML_PROJECT: cancer-detection
      ZENML_STACK: gcp-stack
      ZENML_GITHUB_SHA: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      # Set project and stack (ZenML auto-connects via env vars)
      - name: Configure ZenML
        run: |
          zenml project set $ZENML_PROJECT
          zenml stack set $ZENML_STACK

      # Build snapshot for batch inference (Pro feature)
      - name: Build batch inference snapshot (Pro)
        id: pro_build
        continue-on-error: true
        run: |
          python scripts/build_snapshot.py \
            --pipeline batch_inference \
            --environment production \
            --stack $ZENML_STACK

      - name: Create snapshot summary
        if: steps.pro_build.outcome == 'success'
        run: |
          echo "## ðŸ“¸ Batch Inference Snapshot Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline snapshot ready for scheduled inference runs." >> $GITHUB_STEP_SUMMARY
