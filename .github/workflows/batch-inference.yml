name: Scheduled Batch Inference

# This workflow runs scheduled batch inference in the enterprise-production workspace.
# Part of the 2-workspace architecture for ZenML version upgrade isolation.
#
# The production model is imported from enterprise-dev-staging via the
# promote-production workflow.

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

  workflow_dispatch:
    # Allow manual triggering for testing or ad-hoc runs

jobs:
  batch-inference:
    runs-on: ubuntu-latest
    env:
      # 2-Workspace Architecture: ZenML auto-connects using these env vars
      ZENML_STORE_URL: ${{ secrets.ZENML_PRODUCTION_URL }}
      ZENML_STORE_API_KEY: ${{ secrets.ZENML_PRODUCTION_API_KEY }}
      ZENML_PROJECT: cancer-detection
      ZENML_STACK: gcp-stack

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: pip install uv

      - name: Install dependencies
        run: uv pip install --system -r requirements.txt

      # Set project and stack (ZenML auto-connects via env vars)
      - name: Configure ZenML
        run: |
          zenml project set $ZENML_PROJECT
          zenml stack set $ZENML_STACK

      # ZenML Pro: Run from snapshot (preferred)
      - name: Run batch inference from snapshot (Pro)
        id: pro_run
        continue-on-error: true
        run: |
          # Try to run from existing snapshot
          zenml pipeline runs start batch_inference_pipeline \
            --snapshot latest \
            --config configs/inference_production.yaml 2>/dev/null || exit 1

      # ZenML OSS fallback: Direct execution
      - name: Run batch inference directly (OSS)
        if: steps.pro_run.outcome == 'failure'
        run: |
          echo "Snapshot run failed (OSS?), running pipeline directly..."
          python run.py --pipeline batch_inference --environment production

      - name: Create inference summary
        if: success()
        run: |
          echo "## ðŸ“Š Batch Inference Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "**Workspace:** enterprise-production" >> $GITHUB_STEP_SUMMARY
          echo "**Model:** breast_cancer_classifier (production stage)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the [ZenML Dashboard](https://cloud.zenml.io) for prediction results." >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            // In production, send alert to Slack/PagerDuty/etc.
            console.log('Batch inference failed - alerts would be sent here')

            // Create issue for tracking
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Batch Inference Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `## Batch Inference Failure\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n**Workspace:** enterprise-production\n\nPlease investigate and resolve.`,
              labels: ['incident', 'batch-inference']
            });
